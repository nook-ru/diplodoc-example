# Сборка и подключение стилей страниц в раширения Bitrix (extensions)

Стили отделных страниц из `assets/src/css/pages/<type>/*.scss` собираются в extension типов страниц в `/local/js/citrus/pages/<type/`. 

- [Документация по extension в 1С-Битрикс](https://dev.1c-bitrix.ru/learning/course/index.php?COURSE_ID=43&LESSON_ID=11981)

## Важная информация ⚠️

Для корректной генерации critical css:

- Страницы открываются в браузере, и сервер должен быть доступен по адресу, указанному в `baseUrl` в `gulpfile.js`.
- Типы страниц (pages) должны быть корректно сопоставлены с адресами страниц, где они подключаются на тестовом сервере, см. `pageUrls` в `gulpfile.js`.
- Если на странице используются разные шаблоны или требуется особое сопоставление, используйте свойство страницы или ручную установку типа (об этом ниже)
- Часть страниц *после интеграции верстки* может быть недоступна без авторизации, поэтому на время сборки в gulpfile.js следует указывать тестовые адреса, доступные без авторизации (можно только с версткой и подключением экстеншена) 

## Для фронтенд-разработчиков

### Как устроена сборка стилей страниц

- **Исходные файлы стилей для страниц** располагаются в `assets/src/css/pages/` (достаточно одного SCSS-файла на тип страницы, например, `assets/src/css/pages/about.scss`, `assets/src/css/pages/catalog.scss` и т.д.).
- **Gulp-сборка** автоматически собирает каждую такую папку в отдельный Bitrix-экстеншен. Для каждой страницы создаётся структура:
  ```
  core/local/js/citrus/pages/{page}/
    ├── dist/
    │   ├── style.css         // Скомпилированные и минифицированные стили страницы
    │   └── critical.css      // Critical CSS для этой страницы (см. ниже)
    └── config.php            // Конфиг экстеншена для Bitrix
  ```
- **Critical CSS** для каждой страницы генерируется автоматически после сборки стилей с помощью библиотеки [critical](https://www.npmjs.com/package/critical).
  - Для этого Gulp обходит список URL-ов страниц (см. `pageUrls` в `gulpfile.js`), рендерит каждую страницу и извлекает critical css.
  - Critical CSS сохраняется в `dist/critical.css` внутри соответствующего экстеншена.
  - Если возможно, critical css автоматически исключается из основного `style.css` (чтобы не было дублирования).

### Как добавить или изменить стили страницы

1. Создай или отредактируй SCSS-файл в `assets/src/css/pages/`.
2. Запусти сборку (`npm run build` или соответствующую gulp-задачу).
3. После сборки для каждой страницы будет создан Bitrix-экстеншен с нужной структурой и critical css.

### Где искать результат

- Все собранные экстеншены лежат в `core/local/js/citrus/pages/{page}/`.
- Основные стили страницы — `dist/style.css`.
- Critical CSS — `dist/critical.css`.

---

## Для интеграторов верстки в Bitrix

### Как подключаются стили страниц

- Для каждой страницы сайта подключается свой Bitrix-экстеншен с нужными стилями.
- Подключение экстеншена происходит автоматически через класс `\Citrus\Tools\PageExtension` (см. `core/local/lib/Citrus/Tools/PageExtension.php`).
- Экстеншен определяется по типу страницы (например, `citrus.pages.about`, `citrus.pages.catalog` и т.д.).

### Как определяется тип страницы

Тип страницы определяется в следующем порядке (см. метод `getPageType()`):
1. **Явно установленный тип** через `$pageExtension->setPageType('about')`.
2. **Свойство страницы/раздела**: `$APPLICATION->SetPageProperty('page.type', 'about')`.
3. **Имя первой папки в URL** (например, `/catalog/` → `catalog`).
4. **По умолчанию** — `home` (главная страница).

### Как сопоставить страницу и экстеншен

- Имя экстеншена формируется как `citrus.pages.{тип_страницы}`.
- Например:
  - `/about/` → экстеншен `citrus.pages.about`
  - `/catalog/` → экстеншен `citrus.pages.catalog`
  - `/` (главная) → экстеншен `citrus.pages.home`
- Если нужно явно указать тип страницы, установите свойство страницы или используйте метод `setPageType()`.

### Как работает critical css

- При подключении экстеншена, если в папке есть `dist/critical.css`, он автоматически инлайнится в `<head>` страницы (см. метод `onInit` в `PageExtension.php`).
- Это позволяет ускорить отрисовку первого экрана и избежать дублирования стилей.

### Пример config.php экстеншена

```php
<?php

if (!defined('B_PROLOG_INCLUDED') || B_PROLOG_INCLUDED !== true) die();

return [
    'css' => './dist/style.css',
    'rel' => [],
    'skip_core' => true,
    'oninit' => [\Citrus\Tools\PageExtension::class, 'onInit'],
];
```

